services:
  # Backend API service
  api:
    build: ./backend
    container_name: nfl-zone-api
    volumes:
      - api-data:/app/data
    environment:
      - API_PORT=3000
      - JWT_SECRET=${JWT_SECRET:-nfl-zone-jwt-secret-change-me}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - DB_PATH=/app/data/nflzone.db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - nfl-zone-network

  # Configure the deployment in .env rather than here
  superbowl-sunday:
    image: choiniere/superbowl_sunday:latest
    container_name: ${CONTAINER_NAME}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    environment:
      - BASE_DOMAIN=${BASE_DOMAIN}
      - PUBLIC_IP=${PUBLIC_IP}
      - API_HOST=api:3000
    restart: unless-stopped
    stop_grace_period: 30s
    stop_signal: SIGTERM
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - nfl-zone-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Certbot for SSL certificate management (initial setup only; runs once and exits)
  certbot:
    image: certbot/certbot:v5.0.0
    container_name: certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./enable-https.sh:/enable-https.sh
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SSL_EMAIL=${SSL_EMAIL}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - CONTAINER_NAME=${CONTAINER_NAME}
    entrypoint: ["/enable-https.sh"]
    depends_on:
      - superbowl-sunday
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Periodic SSL renewal (runs every 12h; reloads nginx only when certs renewed)
  certbot-renew:
    image: certbot/certbot:v5.0.0
    container_name: certbot-renew
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./certbot-renew.sh:/certbot-renew.sh
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - BASE_DOMAIN=${BASE_DOMAIN}
      - CONTAINER_NAME=${CONTAINER_NAME}
    entrypoint: ["/bin/sh", "/certbot-renew.sh"]
    depends_on:
      - certbot
      - superbowl-sunday
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Auto-updater for containers
  watchtower:
    image: containrrr/watchtower:1.7.1
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 30 --cleanup --stop-timeout 30s --include-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

volumes:
  api-data:
    driver: local

networks:
  nfl-zone-network:
    driver: bridge