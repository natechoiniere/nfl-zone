services:
  # Configure the deployment in .env rather than here
  superbowl-sunday:
    image: choiniere/superbowl_sunday:latest
    container_name: ${CONTAINER_NAME}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    environment:
      - BASE_DOMAIN=${BASE_DOMAIN}
      - PUBLIC_IP=${PUBLIC_IP}
    restart: unless-stopped
    stop_grace_period: 30s
    stop_signal: SIGTERM
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Certbot for SSL certificate management
  certbot:
    image: certbot/certbot:v5.0.0
    container_name: certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./enable-https.sh:/enable-https.sh
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SSL_EMAIL=${SSL_EMAIL}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - CONTAINER_NAME=${CONTAINER_NAME}
    entrypoint: ["/enable-https.sh"]
    depends_on:
      - superbowl-sunday
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Auto-updater for containers
  watchtower:
    image: containrrr/watchtower:1.7.1
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 30 --cleanup --stop-timeout 30s --include-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"